---

- name: Schedule to change EC2 instance 
  hosts: localhost
  connection: local
  gather_facts: no
  collections:
    - amazon.aws
    - ansible.builtin
    - community.general
    - ansible.controller

  vars_files: 
    - credentials.yml
  vars:
    #Your region
    region: us-east-1

  tasks:

    - name: Build the Schedule for Stopping EC2 instances for {{ which_env }} in the {{ region }} region
      schedule:
        name: Park EC2 instances for {{ which_env }} in the {{ region }} region
        state: present
        unified_job_template: EC2-Stop
        #Future
        #rrule: "{{ query('ansible.controller.schedule_rrule', frequency, start_date=date_time,timezone='GMT',every=repetition | int) }}"
        rrule: "{{ query('ansible.controller.schedule_rrule', 'week', start_date=date_time,timezone='GMT') }}"
        extra_data:
          region: "{{ region }}"
          which_env: "{{ which_env }}"
      tags: schedule_stop_ec2

    - name: Build the Schedule for Starting EC2 instances for {{ which_env }} in the {{ region }} region 
      schedule:
        name: Unpark EC2 instances for {{ which_env }}  in the {{ region }} region
        state: present
        unified_job_template: EC2-Start
        #Future
        #rrule: "{{ query('ansible.controller.schedule_rrule', frequency, start_date=date_time,timezone='GMT',every=repetition | int) }}"
        rrule: "{{ query('ansible.controller.schedule_rrule', 'week', start_date=date_time,timezone='GMT') }}"
        extra_data:
          region: "{{ region }}"
          which_env: "{{ which_env }}"
      tags: schedule_start_ec2